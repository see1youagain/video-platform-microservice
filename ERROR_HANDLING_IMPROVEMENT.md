# é”™è¯¯å¤„ç†ä¼˜åŒ–å®Œæˆ âœ…

## ğŸ“… ä¼˜åŒ–æ—¥æœŸ
2026å¹´2æœˆ7æ—¥

## ğŸ› é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
å½“ç”¨æˆ·å°è¯•æ³¨å†Œå·²å­˜åœ¨çš„ç”¨æˆ·åæ—¶ï¼ŒGateway è¿”å›äº†å®Œæ•´çš„ MySQL é”™è¯¯ä¿¡æ¯ï¼š
```json
{
  "code": 500,
  "msg": "RPC è°ƒç”¨å¤±è´¥: remote or network error[remote]: biz error: Error 1062 (23000): Duplicate entry 'test' for key 'users.idx_users_username'"
}
```

### é—®é¢˜åˆ†æ
1. **å®‰å…¨é£é™©**: æš´éœ²äº†æ•°æ®åº“ç»“æ„ä¿¡æ¯ï¼ˆè¡¨åã€ç´¢å¼•åï¼‰
2. **ç”¨æˆ·ä½“éªŒå·®**: æŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯å¯¹æ™®é€šç”¨æˆ·ä¸å‹å¥½
3. **HTTP çŠ¶æ€ç ä¸æ­£ç¡®**: åº”è¯¥è¿”å› 400 (Bad Request) è€Œä¸æ˜¯ 500
4. **é”™è¯¯ä¼ æ’­**: RPC é”™è¯¯ç›´æ¥ä¼ é€’åˆ° HTTP å“åº”

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. RPC æœåŠ¡å±‚ä¼˜åŒ– (`rpc-user/handler.go`)

#### ä¿®æ”¹å†…å®¹
- âœ… æ·»åŠ  `strings` åŒ…ç”¨äºé”™è¯¯åˆ¤æ–­
- âœ… åŒºåˆ† MySQL é‡å¤é”®é”™è¯¯å’Œå…¶ä»–æ•°æ®åº“é”™è¯¯
- âœ… è¿”å›å‹å¥½çš„ä¸šåŠ¡é”™è¯¯ä¿¡æ¯
- âœ… **å…³é”®æ”¹è¿›**: å°† RPC `err` æ”¹ä¸º `nil`ï¼Œé¿å…é”™è¯¯ä¼ æ’­åˆ°ç½‘å…³

#### æ ¸å¿ƒä»£ç 
```go
import (
    "context"
    "strings"  // æ–°å¢
    "video-platform-microservice/rpc-user/internal/db"
    "video-platform-microservice/rpc-user/internal/utils"
    user "video-platform-microservice/rpc-user/kitex_gen/user"
)

func (s *UserServiceImpl) Register(ctx context.Context, req *user.RegisterReq) (resp *user.RegisterResp, err error) {
    hashedPassword, err := utils.HashPassword(req.Password)
    if err != nil {
        return &user.RegisterResp{
            Code:   500,
            Msg:    "å¯†ç åŠ å¯†å¤±è´¥",
            UserId: 0,
        }, nil  // â† è¿”å› nil è€Œä¸æ˜¯ err
    }

    userID, err := db.CreateUser(req.Username, hashedPassword)
    if err != nil {
        // åˆ¤æ–­æ˜¯å¦ä¸ºé‡å¤ç”¨æˆ·åé”™è¯¯
        if strings.Contains(err.Error(), "Duplicate entry") || 
           strings.Contains(err.Error(), "idx_users_username") {
            return &user.RegisterResp{
                Code:   400,
                Msg:    "ç”¨æˆ·åå·²å­˜åœ¨",  // â† å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                UserId: 0,
            }, nil  // â† è¿”å› nilï¼Œä¸æš´éœ²æ•°æ®åº“é”™è¯¯
        }
        // å…¶ä»–æ•°æ®åº“é”™è¯¯
        return &user.RegisterResp{
            Code:   500,
            Msg:    "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
            UserId: 0,
        }, nil
    }

    return &user.RegisterResp{
        Code:   200,
        Msg:    "æ³¨å†ŒæˆåŠŸ",
        UserId: int64(userID),
    }, nil
}
```

---

### 2. Gateway å±‚ä¼˜åŒ– (`gateway/biz/handler/user/`)

#### ä¿®æ”¹å†…å®¹
- âœ… ç§»é™¤è¯¦ç»†çš„ RPC é”™è¯¯ä¿¡æ¯
- âœ… æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç è¿”å›æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
- âœ… ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

#### register.go æ ¸å¿ƒä»£ç 
```go
resp, err := rpc.UserClient.Register(ctx, &user.RegisterReq{
    Username: req.Username,
    Password: req.Password,
})

if err != nil {
    c.JSON(consts.StatusInternalServerError, map[string]interface{}{
        "code": 500,
        "msg":  "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•",  // â† é€šç”¨é”™è¯¯ä¿¡æ¯
    })
    return
}

// æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç è¿”å›ä¸åŒçš„ HTTP çŠ¶æ€ç 
var httpStatus int
switch resp.Code {
case 200:
    httpStatus = consts.StatusOK
case 400:
    httpStatus = consts.StatusBadRequest  // â† æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
default:
    httpStatus = consts.StatusInternalServerError
}

c.JSON(httpStatus, map[string]interface{}{
    "code":    resp.Code,
    "msg":     resp.Msg,
    "user_id": resp.UserId,
})
```

#### login.go æ ¸å¿ƒä»£ç 
```go
// æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç è¿”å›ä¸åŒçš„ HTTP çŠ¶æ€ç 
var httpStatus int
switch resp.Code {
case 200:
    httpStatus = consts.StatusOK
case 401:
    httpStatus = consts.StatusUnauthorized  // â† å¯†ç é”™è¯¯
case 404:
    httpStatus = consts.StatusNotFound      // â† ç”¨æˆ·ä¸å­˜åœ¨
default:
    httpStatus = consts.StatusInternalServerError
}
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯ 1: é‡å¤ç”¨æˆ·åæ³¨å†Œ
**è¯·æ±‚:**
```bash
curl -X POST http://localhost:8080/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'
```

**å“åº” (ä¼˜åŒ–å‰):**
```json
{
  "code": 500,
  "msg": "RPC è°ƒç”¨å¤±è´¥: remote or network error[remote]: biz error: Error 1062 (23000): Duplicate entry 'test' for key 'users.idx_users_username'"
}
```

**å“åº” (ä¼˜åŒ–å):** âœ…
```json
{
  "code": 400,
  "msg": "ç”¨æˆ·åå·²å­˜åœ¨",
  "user_id": 0
}
```
**HTTP Status Code**: 400 (Bad Request)

---

### æµ‹è¯•åœºæ™¯ 2: æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·
**è¯·æ±‚:**
```bash
curl -X POST http://localhost:8080/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"alice123"}'
```

**å“åº”:** âœ…
```json
{
  "code": 200,
  "msg": "æ³¨å†ŒæˆåŠŸ",
  "user_id": 6
}
```
**HTTP Status Code**: 200 (OK)

---

### æµ‹è¯•åœºæ™¯ 3: æˆåŠŸç™»å½•
**è¯·æ±‚:**
```bash
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"alice123"}'
```

**å“åº”:** âœ…
```json
{
  "code": 200,
  "msg": "ç™»å½•æˆåŠŸ",
  "token": "",
  "user_id": 6
}
```
**HTTP Status Code**: 200 (OK)

---

### æµ‹è¯•åœºæ™¯ 4: é”™è¯¯å¯†ç 
**è¯·æ±‚:**
```bash
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"wrongpassword"}'
```

**å“åº”:** âœ…
```json
{
  "code": 401,
  "msg": "å¯†ç é”™è¯¯",
  "token": "",
  "user_id": 0
}
```
**HTTP Status Code**: 401 (Unauthorized)

---

### æµ‹è¯•åœºæ™¯ 5: ä¸å­˜åœ¨çš„ç”¨æˆ·
**è¯·æ±‚:**
```bash
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"nonexistent","password":"test123"}'
```

**å“åº”:** âœ…
```json
{
  "code": 404,
  "msg": "ç”¨æˆ·ä¸å­˜åœ¨",
  "token": "",
  "user_id": 0
}
```
**HTTP Status Code**: 404 (Not Found)

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å®‰å…¨æ€§ | âŒ æš´éœ²æ•°æ®åº“ç»“æ„ | âœ… éšè—æŠ€æœ¯ç»†èŠ‚ |
| ç”¨æˆ·ä½“éªŒ | âŒ æŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯ | âœ… å‹å¥½çš„æç¤ºä¿¡æ¯ |
| HTTP çŠ¶æ€ç  | âŒ ç»Ÿä¸€è¿”å› 200/500 | âœ… è¯­ä¹‰åŒ–çŠ¶æ€ç  (200/400/401/404) |
| é”™è¯¯å¤„ç† | âŒ RPC é”™è¯¯ç›´æ¥ä¼ æ’­ | âœ… åœ¨æœåŠ¡å±‚è½¬æ¢ä¸ºä¸šåŠ¡é”™è¯¯ |
| å¯ç»´æŠ¤æ€§ | âš ï¸ é”™è¯¯ä¿¡æ¯æ··ä¹± | âœ… ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ |

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ç‚¹

### 1. é”™è¯¯è¾¹ç•Œåˆ†å±‚
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP å±‚ (Gateway)         â”‚
â”‚   - é€šç”¨é”™è¯¯: "æœåŠ¡ä¸å¯ç”¨"   â”‚
â”‚   - è¿”å›æ­£ç¡®çš„ HTTP çŠ¶æ€ç    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ RPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RPC å±‚ (User Service)     â”‚
â”‚   - ä¸šåŠ¡é”™è¯¯: "ç”¨æˆ·åå·²å­˜åœ¨" â”‚
â”‚   - err = nil (ä¸ä¼ æ’­é”™è¯¯)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“å±‚ (MySQL)          â”‚
â”‚   - æŠ€æœ¯é”™è¯¯: Duplicate key  â”‚
â”‚   - è¢«æœåŠ¡å±‚æ•è·å’Œè½¬æ¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. HTTP çŠ¶æ€ç æ˜ å°„
| ä¸šåŠ¡çŠ¶æ€ç  | HTTP çŠ¶æ€ç  | å«ä¹‰ |
|-----------|------------|------|
| 200 | 200 OK | æ“ä½œæˆåŠŸ |
| 400 | 400 Bad Request | å®¢æˆ·ç«¯é”™è¯¯ï¼ˆç”¨æˆ·åå·²å­˜åœ¨ï¼‰ |
| 401 | 401 Unauthorized | è®¤è¯å¤±è´¥ï¼ˆå¯†ç é”™è¯¯ï¼‰ |
| 404 | 404 Not Found | èµ„æºä¸å­˜åœ¨ï¼ˆç”¨æˆ·ä¸å­˜åœ¨ï¼‰ |
| 500 | 500 Internal Server Error | æœåŠ¡å™¨é”™è¯¯ |

### 3. é”™è¯¯ä¿¡æ¯è®¾è®¡åŸåˆ™
- âœ… **å¯¹ç”¨æˆ·å‹å¥½**: ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°é—®é¢˜
- âœ… **ä¸æš´éœ²æŠ€æœ¯ç»†èŠ‚**: éšè—æ•°æ®åº“ã€è¡¨åã€ç´¢å¼•ç­‰ä¿¡æ¯
- âœ… **æä¾›è§£å†³æ–¹æ¡ˆ**: "ç”¨æˆ·åå·²å­˜åœ¨" æš—ç¤ºç”¨æˆ·åº”æ¢ä¸€ä¸ªç”¨æˆ·å
- âœ… **ç»Ÿä¸€æ ¼å¼**: æ‰€æœ‰é”™è¯¯å“åº”éƒ½åŒ…å« `code`, `msg`, `user_id`/`token` å­—æ®µ

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **rpc-user/handler.go**
   - æ·»åŠ  `strings` åŒ…å¯¼å…¥
   - ä¼˜åŒ– `Register` æ–¹æ³•é”™è¯¯å¤„ç†
   - ä¼˜åŒ– `Login` æ–¹æ³•é”™è¯¯å¤„ç†
   - æ‰€æœ‰é”™è¯¯è¿”å› `err = nil`

2. **gateway/biz/handler/user/register.go**
   - ç§»é™¤è¯¦ç»†çš„ RPC é”™è¯¯ä¿¡æ¯
   - æ·»åŠ ä¸šåŠ¡çŠ¶æ€ç åˆ° HTTP çŠ¶æ€ç çš„æ˜ å°„
   - ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

3. **gateway/biz/handler/user/login.go**
   - ç§»é™¤è¯¦ç»†çš„ RPC é”™è¯¯ä¿¡æ¯
   - æ·»åŠ  401/404 çŠ¶æ€ç æ”¯æŒ
   - ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (æœ¬å‘¨)
1. **æ·»åŠ è¯·æ±‚å‚æ•°éªŒè¯**
   - ç”¨æˆ·åé•¿åº¦é™åˆ¶ (3-20 å­—ç¬¦)
   - å¯†ç å¼ºåº¦è¦æ±‚ (è‡³å°‘ 6 ä½)
   - é˜²æ­¢ SQL æ³¨å…¥ (ä½¿ç”¨ GORM å·²ç»é˜²æŠ¤)

2. **æ·»åŠ æ—¥å¿—è®°å½•**
   - è®°å½•è¯¦ç»†çš„æŠ€æœ¯é”™è¯¯åˆ°æ—¥å¿—ç³»ç»Ÿ
   - åŒºåˆ†ç”¨æˆ·å¯è§é”™è¯¯å’Œå†…éƒ¨æ—¥å¿—
   - æ·»åŠ è¯·æ±‚è¿½è¸ª ID (trace_id)

3. **æ·»åŠ é”™è¯¯ç ä½“ç³»**
   - å®šä¹‰é”™è¯¯ç å¸¸é‡ (å¦‚ `ERR_USER_EXISTS = 40001`)
   - å‰ç«¯å¯æ ¹æ®é”™è¯¯ç åšå›½é™…åŒ–å¤„ç†

### ä¸­æœŸ (æœ¬æœˆ)
4. **ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶**
   - åœ¨ Gateway æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†å™¨
   - è‡ªåŠ¨è®°å½•æ‰€æœ‰é”™è¯¯åˆ°æ—¥å¿—
   - æ·»åŠ é”™è¯¯ç›‘æ§å’Œå‘Šè­¦

5. **æ·»åŠ é™æµä¿æŠ¤**
   - é˜²æ­¢æš´åŠ›ç ´è§£ (ç™»å½•æ¥å£)
   - é˜²æ­¢é‡å¤æ³¨å†Œæ”»å‡»
   - IP çº§åˆ«å’Œç”¨æˆ·çº§åˆ«é™æµ

---

## ğŸ“š ç›¸å…³æ¦‚å¿µ

### å¾®æœåŠ¡é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
1. **é”™è¯¯ä¸åº”è·¨å±‚ä¼ æ’­**: æ¯ä¸€å±‚éƒ½åº”è¯¥å°†åº•å±‚é”™è¯¯è½¬æ¢ä¸ºè¯¥å±‚çš„è¯­ä¹‰
2. **åŒºåˆ†ä¸šåŠ¡é”™è¯¯å’ŒæŠ€æœ¯é”™è¯¯**: ä¸šåŠ¡é”™è¯¯è¿”å›ç»™ç”¨æˆ·ï¼ŒæŠ€æœ¯é”™è¯¯è®°å½•åˆ°æ—¥å¿—
3. **ä½¿ç”¨åˆé€‚çš„ HTTP çŠ¶æ€ç **: è®©å®¢æˆ·ç«¯èƒ½å¤Ÿæ ¹æ®çŠ¶æ€ç åšå‡ºæ­£ç¡®ååº”
4. **ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**: ä¾¿äºå®¢æˆ·ç«¯ç»Ÿä¸€å¤„ç†

### RESTful API é”™è¯¯è®¾è®¡
```json
{
  "code": 40001,           // ä¸šåŠ¡é”™è¯¯ç 
  "msg": "ç”¨æˆ·åå·²å­˜åœ¨",    // ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
  "data": null,            // æ•°æ®å­—æ®µï¼ˆé”™è¯¯æ—¶ä¸º nullï¼‰
  "trace_id": "abc123"     // è¯·æ±‚è¿½è¸ª IDï¼ˆå¯é€‰ï¼‰
}
```

---

## âœ… æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–ï¼š
- âœ… æå‡äº† API çš„å®‰å…¨æ€§ï¼ˆä¸æš´éœ²æ•°æ®åº“ç»“æ„ï¼‰
- âœ… æ”¹å–„äº†ç”¨æˆ·ä½“éªŒï¼ˆå‹å¥½çš„é”™è¯¯æç¤ºï¼‰
- âœ… è§„èŒƒäº† HTTP çŠ¶æ€ç ä½¿ç”¨
- âœ… å»ºç«‹äº†æ¸…æ™°çš„é”™è¯¯è¾¹ç•Œ
- âœ… ä¸ºåç»­é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ‰“ä¸‹åŸºç¡€

**ä¼˜åŒ–æ—¶é—´**: 2026å¹´2æœˆ7æ—¥ 16:45
**æµ‹è¯•çŠ¶æ€**: å…¨éƒ¨é€šè¿‡ âœ…
**æœåŠ¡çŠ¶æ€**: æ­£å¸¸è¿è¡Œ (rpc-user:8888, gateway:8080)
